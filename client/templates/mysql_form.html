<div class="row">
<div class="col-md-offset-2 col-md-8">
    <form class="form-horizontal" name="qanForm">
        <div class="panel panel-default">
            <div class="panel-heading">
                <div class="row">
                    <div class="col-md-3">
                        <h4>Query Analytics</h4>
                    </div>
                </div>
            </div>
            <div class="panel-body" ng-if="!instance.UUID">
                <div class="alert alert-info" role="alert">
                    Create MySQL Connection first.
                </div>
            </div>
            <div class="panel-body" ng-if="!!instance.UUID">

                <div class="form-group form-group-sm">
                    <label class="col-sm-3 control-label">DSN</label>
                    <div class="col-sm-9">
                        <p class="form-control-static">{{ popoverDSN }}</p>
                    </div>
                </div>

                <div class="form-group form-group-sm">
                    <label class="col-sm-3 control-label">Version</label>
                    <div class="col-sm-9">
                        <p class="form-control-static">{{ instance.Version }} {{ $root.instance.Distro }}</p>
                    </div>
                </div>

                <div class="form-group form-group-sm">
                    <label for="inputConf" class="col-sm-3 control-label"><span class="text-bigger">Configuration</span></label>
                    <div class="col-sm-9">
                        <label for="inputConfAuto" class="col-md-4 control-label">
                            <input type="radio" id="inputConfAuto" name="config"
                                   ng-model="qanConf.config" ng-value="'auto'">
                            Automatic
                        </label>
                        <label for="inputConfManual" class="col-md-3 control-label">
                            <input type="radio" id="inputConfManual" name="config"
                                   ng-model="qanConf.config" ng-value="'manual'">
                            Manual
                        </label>
                    </div>
                </div>
                <hr />


                <div class="form-group form-group-sm" ng-if="qanConf.config === 'auto'">
                    <div class="col-sm-12">
                        <div class="alert alert-info" role="alert">
                            The agent will automatically configure MySQL based on its distribution and version. This is safe for production.
                        </div>

                        <div ng-if="instance.Distro !== '' && instance.Distro.toLowerCase().indexOf('percona server') === -1" class="alert alert-warning" role="alert">
                            This MySQL instance is not running
                            <a href="https://www.percona.com/software/mysql-database/percona-server">Percona Server</a>.
                            For best results, upgrade to Percona Server.
                        </div>
                    </div>
                </div>

                <span ng-if="qanConf.config === 'manual'">

                <div class="form-group form-group-sm">
                    <label for="inputInterval" class="col-sm-3 control-label">Collect interval</label>
                    <div class="col-sm-2">
                        <input class="form-control"
                               type="number"
                               min="1"
                               id="inputInterval"
                               name="interval"
                               ng-disabled="!qanConfLock.Interval"
                               aria-describedby="intervalHelpBlock"
                               ng-model="qanConf.Interval">
                    </div>
                    <div class="col-sm-2">
                        <span id="intervalHelpBlock" class="help-block"><small>minute(s)</small></span>
                    </div>
                    <div class="col-sm-3">
                        <span id="intervalLockHelpBlock"
                              class="help-block pull-right">
                            <abbr class="text-danger"
                                  style=""
                                  popover-append-to-body="true"
                                  popover-placement="left"
                                  popover-trigger="mouseenter"
                                  popover="Pins show which options are set or not set.
                                           Options with grey pins are not set, so the agent will use its built-in default value,
                                           which can change depending on the agent and MySQL version.
                                           Options with red pins are set, so the agent will always use the value shown."
                                  >What's this?</abbr>
                            &nbsp;<i class="glyphicon glyphicon-arrow-right"></i>
                        </span>
                    </div>
                    <div class="col-sm-2">
                        <button type="button" class="btn btn-default"
                                id="IntervalLock"
                                aria-describedby="intervalLockHelpBlock"
                                ng-model="qanConfLock.Interval"
                                title="{{ qanConfLock.Interval ? 'Use default value' : 'Set specific value' }}"
                                btn-checkbox >
                            <i class="glyphicon glyphicon-pushpin text-muted"
                                ng-class="{'text-danger pinned': qanConfLock.Interval}"
                                ></i>
                        </button>
                    </div>
                </div>

                <div class="form-group form-group-sm">
                    <div class="col-sm-offset-3 col-sm-7">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox"
                                       ng-disabled="!qanConfLock.ExampleQueries"
                                       ng-model="qanConf.ExampleQueries">
                                <small><b>Send real query examples</b></small>
                            </label>
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <button type="button" class="btn btn-default"
                                ng-model="qanConfLock.ExampleQueries"
                                title="{{ qanConfLock.ExampleQueries ? 'Use default value' : 'Set specific value' }}"
                                btn-checkbox>
                            <i class="glyphicon glyphicon-pushpin text-muted"
                                ng-class="{'text-danger pinned': qanConfLock.ExampleQueries}"
                                ></i>
                        </button>
                    </div>
                </div>

                <hr />

                <div class="form-group form-group-sm">
                    <label for="inputSource" class="col-sm-3 control-label">Collect from</label>
                    <div class="col-sm-4">
                        <select class="form-control"
                                id="inputSource"
                                name="source"
                                ng-options="k as v for (k, v) in {'slowlog': 'Slow log', 'perfschema': 'Performance Schema'}"
                                ng-model="qanConf.CollectFrom">
                        </select>
                    </div>
                </div>

                <fieldset ng-if="qanConf.CollectFrom === 'slowlog'">
                    <legend>Slow Log Configuration</legend>

                <div class="form-group form-group-sm" ng-class="{ 'has-error' : qanForm.longQueryTime.$invalid && !qanForm.longQueryTime.$pristine }">
                    <label for="inputLongQueryTime" class="col-sm-3 control-label">Long query time</label>
                    <div class="col-sm-2">
                        <input class="form-control"
                               type="text"
                               ng-pattern="'(0|0\.[0-9]{1,6})'"
                               id="inputLongQueryTime"
                               name="longQueryTime"
                               ng-disabled="!qanConfLock.LongQueryTime"
                               aria-describedby="longQueryTimeHelpBlock"
                               ng-model="qanConf.LongQueryTime">
                    </div>
                    <div class="col-sm-5">
                        <span id="longQueryTimeHelpBlock" class="help-block"><small>second</small></span>
                    </div>
                    <div class="col-sm-2">
                        <button type="button" class="btn btn-default"
                                ng-model="qanConfLock.LongQueryTime"
                                title="{{ qanConfLock.LongQueryTime ? 'Use default value' : 'Set specific value' }}"
                                btn-checkbox>
                            <i class="glyphicon glyphicon-pushpin text-muted"
                                ng-class="{'text-danger pinned': qanConfLock.LongQueryTime}"
                                ></i>
                        </button>
                    </div>
                </div>

                <div class="form-group form-group-sm" ng-class="{ 'has-error' : qanForm.maxSlowLogSize.$invalid && !qanForm.maxSlowLogSize.$pristine }">
                    <label for="inputMaxSlowLogSize" class="col-sm-3 control-label">Max slow log size</label>
                    <div class="col-sm-2">
                        <input class="form-control"
                               type="text"
                               id="inputMaxSlowLogSize"
                               ng-disabled="!qanConfLock.MaxSlowLogSize"
                               ng-pattern="'(|0|[1-9][0-9]*[KMGPY]?B)?'"
                               name="maxSlowLogSize"
                               aria-describedby="maxSlowLogSizeHelpBlock"
                               ng-model="qanConf.MaxSlowLogSize">
                    </div>
                    <div class="col-sm-5">
                        <span id="maxSlowLogSizeHelpBlock" class="help-block"><small>Ex.: 1GB, 200MB, 0 = no max</small></span>
                    </div>
                    <div class="col-sm-2">
                        <button type="button" class="btn btn-default"
                                ng-model="qanConfLock.MaxSlowLogSize"
                                title="{{ qanConfLock.MaxSlowLogSize ? 'Use default value' : 'Set specific value' }}"
                                btn-checkbox>
                            <i class="glyphicon glyphicon-pushpin text-muted"
                                ng-class="{'text-danger pinned': qanConfLock.MaxSlowLogSize}"
                                ></i>
                        </button>
                    </div>
                </div>

                <div class="form-group form-group-sm">
                    <div class="col-sm-offset-3 col-sm-7">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox"
                                       ng-disabled="!qanConfLock.RemoveOldSlowLogs"
                                       ng-model="qanConf.RemoveOldSlowLogs">
                                <small><b>Remove old slow logs</b></small>
                            </label>
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <button type="button" class="btn btn-default"
                                ng-model="qanConfLock.RemoveOldSlowLogs"
                                title="{{ qanConfLock.RemoveOldSlowLogs ? 'Use default value' : 'Set specific value' }}"
                                btn-checkbox>
                            <i class="glyphicon glyphicon-pushpin text-muted"
                                ng-class="{'text-danger pinned': qanConfLock.RemoveOldSlowLogs}"
                                ></i>
                        </button>
                    </div>
                </div>


                </fieldset>

                <fieldset ng-if="qanConf.CollectFrom === 'slowlog'">
                    <legend>Percona Server</legend>

                    <div ng-if="instance.Distro.toLowerCase().indexOf('percona server') === -1" class="alert alert-warning" role="alert">
                        Upgrade to Percona Server to enable these options.
                    </div>

                    <span ng-if="instance.Distro.toLowerCase().indexOf('percona server') > -1">
                        <div class="form-group form-group-sm">
                            <label for="inputSlowLogVerbosity" class="col-sm-3 control-label">Slow log verbosity</label>
                            <div class="col-sm-4">
                                <select class="form-control"
                                        id="inputSlowLogVerbosity"
                                        name="slowLogVerbosity"
                                        ng-disabled="!qanConfLock.SlowLogVerbosity"
                                        ng-options="k as v for (k, v) in {'full': 'Full', 'standard': 'Standard', 'minimal': 'Minimal'}"
                                        ng-model="qanConf.SlowLogVerbosity">
                                </select>
                            </div>
                            <div class="col-sm-offset-3 col-sm-2">
                                <button type="button" class="btn btn-default"
                                                      ng-model="qanConfLock.SlowLogVerbosity"
                                                      title="{{ qanConfLock.SlowLogVerbosity ? 'Use default value' : 'Set specific value' }}"
                                                      btn-checkbox>
                                    <i class="glyphicon glyphicon-pushpin text-muted"
                                       ng-class="{'text-danger pinned': qanConfLock.SlowLogVerbosity}"
                                       ></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group form-group-sm">
                            <label for="inputRateLimit" class="col-sm-3 control-label">Rate limit</label>
                            <div class="col-sm-4">
                                <input class="form-control"
                                       type="number"
                                       min="0"
                                       id="inputRateLimit"
                                       name="rateLimit"
                                       ng-disabled="!qanConfLock.RateLimit"
                                       aria-describedby="rateLimitHelpBlock"
                                       ng-model="qanConf.RateLimit">
                            </div>
                            <div class="col-sm-3">
                                <span id="rateLimitHelpBlock" class="help-block"><small>0 and 1 = disabled</small></span>
                            </div>
                            <div class="col-sm-2">
                                <button type="button" class="btn btn-default"
                                                      ng-model="qanConfLock.RateLimit"
                                                      title="{{ qanConfLock.RateLimit ? 'Use default value' : 'Set specific value' }}"
                                                      btn-checkbox>
                                    <i class="glyphicon glyphicon-pushpin text-muted"
                                       ng-class="{'text-danger pinned': qanConfLock.RateLimit}"
                                       ></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group form-group-sm">
                            <div class="col-sm-offset-3 col-sm-7">
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox"
                                               ng-disabled="!qanConfLock.LogSlowAdminStatements"
                                               ng-model="qanConf.LogSlowAdminStatements">
                                        <small><b>Log slow admin statements</b></small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-sm-2">
                                <button type="button" class="btn btn-default"
                                                      ng-model="qanConfLock.LogSlowAdminStatements"
                                                      title="{{ qanConfLock.LogSlowAdminStatements ? 'Use default value' : 'Set specific value' }}"
                                                      btn-checkbox>
                                    <i class="glyphicon glyphicon-pushpin text-muted"
                                       ng-class="{'text-danger pinned': qanConfLock.LogSlowAdminStatements}"
                                       ></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group form-group-sm">
                            <div class="col-sm-offset-3 col-sm-7">
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox"
                                               ng-disabled="!qanConfLock.LogSlowSlaveStatemtents"
                                               ng-model="qanConf.LogSlowSlaveStatemtents">
                                        <small><b>Log slow slave statements</b></small>
                                    </label>
                                </div>
                            </div>

                            <div class="col-sm-2">
                                <button type="button" class="btn btn-default"
                                                      ng-model="qanConfLock.LogSlowSlaveStatemtents"
                                                      title="{{ qanConfLock.LogSlowSlaveStatemtents ? 'Use default value' : 'Set specific value' }}"
                                                      btn-checkbox>
                                    <i class="glyphicon glyphicon-pushpin text-muted"
                                       ng-class="{'text-danger pinned': qanConfLock.LogSlowSlaveStatemtents}"
                                       ></i>
                                </button>
                            </div>

                        </div>
                    </span>

                </fieldset>

            </span>


            </div>
            <div class="panel-footer" ng-if="!!instance.UUID">
                <div class="form-group form-group-sm" >
                    <div class="col-sm-offset-3 col-md-2">
                        <button type="submit"
                                ng-click="setQanConfig(selected_agent)"
                                ng-disabled="DEMO || qanForm.$invalid"
                                class="btn btn-primary btn-sm" >
                            <i class="glyphicon glyphicon-ok"></i>
                            Apply
                        </button>
                    </div>
                    <div class="col-md-offset-2 col-md-2" style="padding-top: 5px !important;">
                        <a href=""
                                popover-append-to-body="true"
                                popover-placement="up"
                                popover-template="'jsonPopoverTemplate.html'" popover-title="To set up this qan config click 'Apply' button"
                                >
                                <i class="glyphicon glyphicon-search"></i>
                                Config
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>

</div>
</div>

<script type="text/ng-template" id="jsonPopoverTemplate.html">
    <pre>{{ qanConfNew | json }}</pre>
</script>
